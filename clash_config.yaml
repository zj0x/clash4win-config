# 深川有喵「Clash_Mini」骨架 + Jun 粗简分流（AI / YouTube / GitHub，适配 AdGuard DNS）
# 内核：Mihomo / Clash.Meta
# 平台：Windows（TUN + AdGuard 做 DNS/去广告）

port: 7890
socks-port: 7891
mixed-port: 7892
redir-port: 7893
tproxy-port: 7894

unified-delay: true
geodata-mode: false
geodata-loader: standard
geo-auto-update: true
geo-update-interval: 24
tcp-concurrent: true
find-process-mode: strict
global-client-fingerprint: chrome

allow-lan: true
mode: rule
log-level: info
ipv6: true
udp: true

external-controller: 0.0.0.0:9090
# external-ui: ui
# external-ui-url: 'https://github.com/MetaCubeX/metacubexd/archive/refs/heads/gh-pages.zip'

geox-url:
  # geoip: 'https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/geoip.dat'
  # geosite: 'https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/geosite.dat'
  mmdb: 'https://geodata.kelee.one/Country-Masaiki.mmdb'
  asn: 'https://geodata.kelee.one/GeoLite2-ASN-P3TERX.mmdb'

profile:
  store-selected: true
  store-fake-ip: true

sniffer:
  enable: true
  force-dns-mapping: true
  parse-pure-ip: true
  override-destination: true
  sniff:
    HTTP:
      ports: [80, 8080-8880]
      override-destination: true
    TLS:
      ports: [443, 8443]
    QUIC:
      ports: [443, 8443]
  force-domain:
    - +.v2ex.com
  skip-domain:
    - Mijia Cloud

tun:
  enable: true
  stack: system
  # 使用 AdGuard 做 DNS，不再在此加持 53 端口
  # dns-hijack:
  #   - any:53
  auto-route: true
  auto-detect-interface: true

# 额外 socks5 入口（可选）
listeners:
  - name: socks5-in-1
    type: socks
    port: 10808
    listen: 0.0.0.0
    udp: true
    users: []
    proxy: DIRECT

# DNS 完全交给 AdGuard，Clash/Mihomo 不再管理 DNS
dns:
  enable: false

proxies: []

# 节点计费参数（每 24 小时刷新节点，60 秒健康检查）
NodeParam: &NodeParam
  type: http
  interval: 86400
  health-check:
    enable: true
    url: 'https://cp.cloudflare.com/generate_204'
    interval: 60

# 计费节点（TODO：改成你的机场计费地址）
proxy-providers:
  我的节点:
    <<: *NodeParam
    url: 'https://api.wd-red.com/sub?target=clash&emoji=true&udp=true&scv=true&new_name=true&filename=WestData&url=https%3A%2F%2Fwd-red.com%2Fsubscribe%2Fnxyvnm-p1aasfef-N9zBNh3Id924'
    path: './proxy_provider/Providers.yaml'

# 按你现在的命名风格筛选：Hong Kong | 01 / Japan | 03 / United States | 07 / Netherlands | 02 / United Kingdom | 01 ...
FilterHK: &FilterHK "(?i)Hong Kong"
FilterTW: &FilterTW "(?i)Taiwan"
FilterJP: &FilterJP "(?i)Japan"
FilterSG: &FilterSG "(?i)Singapore"
FilterUS: &FilterUS "(?i)United States"
FilterDE: &FilterDE "(?i)Germany"
FilterUK: &FilterUK "(?i)United Kingdom"
FilterNL: &FilterNL "(?i)Netherlands"

# 钧点 - 故障转移参数（预留，有需要可以把 url-test 改成 fallback 使用）
FallBack: &FallBack
  type: fallback
  interval: 10
  lazy: true
  url: 'https://cp.cloudflare.com/generate_204'
  disable-udp: false
  timeout: 3000
  max-failed-times: 3
  hidden: true
  include-all-providers: true

RuleSet: &RuleSet
  type: http
  behavior: classical
  interval: 86400
  format: yaml
  proxy: Proxy

proxy-groups:
  # 顶层总出网控制：
  # - 显式列出各国家自动组 + DIRECT
  # - 同时通过 use: 把计费里所有节点也拉进来（你机场的所有节点都可以手动选）
  - name: Proxy
    type: select
    proxies:
      - AUTO-HK
      - AUTO-TW
      - AUTO-JP
      - AUTO-SG
      - AUTO-US
      - AUTO-DE
      - AUTO-UK
      - AUTO-NL
      - DIRECT
    use:
      - 我的节点

  # AI 专用：OpenAI / Claude / Perplexity / Copilot / Gemini / Grok 等
  - name: AI
    type: select
    proxies:
      - AUTO-US
      - AUTO-DE
      - AUTO-UK
      - AUTO-NL
      - AUTO-HK
      - AUTO-JP
      - AUTO-SG
      - Proxy
      - DIRECT

  # YouTube 专用：优先亚洲低延迟
  - name: YouTube
    type: select
    proxies:
      - AUTO-HK
      - AUTO-TW
      - AUTO-JP
      - AUTO-SG
      - AUTO-US
      - Proxy
      - DIRECT

  # GitHub 专用：优先美/欧，其次亚洲
  - name: GitHub
    type: select
    proxies:
      - AUTO-US
      - AUTO-DE
      - AUTO-UK
      - AUTO-NL
      - AUTO-HK
      - AUTO-JP
      - Proxy
      - DIRECT

  # 各国家自动测速组（本国节点内 url-test，不跨国）
  - name: AUTO-HK
    type: url-test
    use:
      - 我的节点
    filter: *FilterHK
    url: https://cp.cloudflare.com/generate_204
    interval: 300

  - name: AUTO-TW
    type: url-test
    use:
      - 我的节点
    filter: *FilterTW
    url: https://cp.cloudflare.com/generate_204
    interval: 300

  - name: AUTO-JP
    type: url-test
    use:
      - 我的节点
    filter: *FilterJP
    url: https://cp.cloudflare.com/generate_204
    interval: 300

  - name: AUTO-SG
    type: url-test
    use:
      - 我的节点
    filter: *FilterSG
    url: https://cp.cloudflare.com/generate_204
    interval: 300

  - name: AUTO-US
    type: url-test
    use:
      - 我的节点
    filter: *FilterUS
    url: https://cp.cloudflare.com/generate_204
    interval: 300

  - name: AUTO-DE
    type: url-test
    use:
      - 我的节点
    filter: *FilterDE
    url: https://cp.cloudflare.com/generate_204
    interval: 300

  - name: AUTO-UK
    type: url-test
    use:
      - 我的节点
    filter: *FilterUK
    url: https://cp.cloudflare.com/generate_204
    interval: 300

  - name: AUTO-NL
    type: url-test
    use:
      - 我的节点
    filter: *FilterNL
    url: https://cp.cloudflare.com/generate_204
    interval: 300

rule-providers:
  # 使用 EAlyce 的 OpenAI.list，覆盖绊大多数 AI 相关域名
  OpenAI:
    <<: *RuleSet
    url: "https://raw.githubusercontent.com/EAlyce/conf/refs/heads/main/Rule/OpenAI.list"
    path: "./RuleSet/OpenAI.list"
    format: text

rules:
  # ======== AI：所有命中 OpenAI.list 的域名/IP 都走 AI 组 ========
  - RULE-SET,OpenAI,AI

  # 兜底补强：以防规则集缺少具有典型域名
  - DOMAIN-SUFFIX,chatgpt.com,AI
  - DOMAIN-SUFFIX,openai.com,AI
  - DOMAIN-SUFFIX,api.openai.com,AI
  - DOMAIN-SUFFIX,claude.ai,AI
  - DOMAIN-SUFFIX,perplexity.ai,AI
  - DOMAIN-SUFFIX,githubcopilot.com,AI
  - DOMAIN-SUFFIX,copilot.microsoft.com,AI
  - DOMAIN-SUFFIX,gemini.google.com,AI

  # Adobe防验证设置
  - DOMAIN-SUFFIX,adobe.io,REJECT
  - DOMAIN-SUFFIX,*.adobe.io,REJECT
  - DOMAIN-SUFFIX,adobestats.io,REJECT
  - DOMAIN-SUFFIX,photo-api.adobe.io,DIRECT

  # ======== YouTube：视频全部走 YouTube 组（亚洲优先） ========
  - DOMAIN-SUFFIX,youtube.com,YouTube
  - DOMAIN-SUFFIX,googlevideo.com,YouTube
  - DOMAIN-SUFFIX,ytimg.com,YouTube
  - DOMAIN-SUFFIX,yt3.ggpht.com,YouTube

  # ======== GitHub：代码托管全部走 GitHub 组（US/EU 优先） ========
  - DOMAIN-SUFFIX,github.com,GitHub
  - DOMAIN-SUFFIX,githubusercontent.com,GitHub
  - DOMAIN-SUFFIX,githubassets.com,GitHub
  - DOMAIN-SUFFIX,ghcr.io,GitHub

  # ======== 局域网 & 国内直达 ========
  - IP-CIDR,127.0.0.0/8,DIRECT,no-resolve
  - IP-CIDR,10.0.0.0/8,DIRECT,no-resolve
  - IP-CIDR,172.16.0.0/12,DIRECT,no-resolve
  - IP-CIDR,192.168.0.0/16,DIRECT,no-resolve
  - IP-CIDR,224.0.0.0/4,DIRECT,no-resolve
  - GEOIP,CN,DIRECT

  # 其余全部走 Proxy（再由你在 GUI 里选择默认出口）
  - MATCH,Proxy
